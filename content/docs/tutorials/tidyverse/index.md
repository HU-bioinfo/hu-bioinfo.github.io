---
title: "Tidyverse"
weight: 4
# bookFlatSection: false
# bookToc: true
# bookHidden: false
# bookCollapseSection: false
# bookComments: false
# bookSearchExclude: false
---

# Tidyverse


## Tidyverseってなんぞや
Tidyverseは，データ分析と可視化を効率的に行うために設計されたR言語のパッケージ群です．
このパッケージの思想上の特徴として**Tidy Data**の原則のもと，一貫性のある操作体系により，データ処理の生産性を保つことを特徴としています．

とはいえ含まれる内容や思想も膨大かつ難解なので，この章では，よくする使い方をメインに書いていきます．
より詳しく知りたい方は，それぞれ詳細のページを見てください．

{{% details title="Tidyverseのパッケージ群" open=false %}}

| パッケージ名 | 役割                           | 主な機能                                                   | 
| ------------ | ------------------------------ | ---------------------------------------------------------- | 
| ggplot2      | データ可視化                   | グラフィックスの文法に基づいて、グラフを宣言的に作成できる | 
| dplyr        | データ操作                     | フィルタリング，要約，並べ替え，結合といったデータ操作     | 
| tidyr        | データ整理                     | **Tidy data**作成                                          | 
| readr        | データ読み込み                 | 矩形データ（csv、tsv、fwfなど）の高速読み込み              | 
| purrr        | 関数型プログラミング           | ベクトルやリストの操作（map関数など）                      | 
| tibble       | データフレームの現代的な再構築 | モダンなデータフレーム構造                                 | 
| stringr      | 文字列操作                     | パターンマッチングや文字列の処理                           | 
| forcats      | 因子型操作                     | 因子データのレベルの順序や値の変更など                     | 
| lubridate    | 日付・時刻データ操作           | 日付や時間の解析と処理                                     | 

{{% /details %}}


## Tidy Data

基本的にデータはExcelのように表形式となったデータを扱います．この時，ただ漫然と表を作成するのではなく，一定のルールの下に作成，加工していくことで効率や安全性が増します．具体的なルールとは以下の三つのことです.

1. 一つの変数は一つの列に（Each variable must have its own column.）
2. 一つの観測は一つの行に（Each observation must have its own row.）
3. 一つの値は一つのセルに（Each value must have its own cell.）

上記3つを満たした表形式のデータを **Tidy Data(整列データ)** といいます．

### 一つの変数は一つの列に（Each variable must have its own column.）
この原則における変数とは，データの特徴を表すものです．人を対象にしたデータだとすると名前，身長，体重，年齢などが該当します．

{{% tabs "1st_principle" %}}
{{% tab "良い例" %}}
| 名前  | 年齢 | 身長 (cm) | 体重 (kg) |
|------|----|----------|----------|
| 太郎  | 25  | 170      | 65       |
| 花子  | 22  | 160      | 50       |
{{% /tab %}}
{{% tab "悪い例" %}}
| 名前  | 属性   | 値   |
|------|------|------|
| 太郎  | 年齢  | 25   |
| 太郎  | 身長  | 170  |
| 太郎  | 体重  | 65   |
| 花子  | 年齢  | 22   |
| 花子  | 身長  | 160  |
| 花子  | 体重  | 50   |
{{% /tab %}}
{{% /tabs %}}

### 一つの観測は一つの行に（Each observation must have its own row.）
観測とは、一つのデータのまとまりのことを指します．人を対象にしたデータだとすると名前がAlice,身長160cm，体重50kg，年齢20歳という一人のデータのことを指します．

{{% tabs "2st_principle" %}}
{{% tab "良い例" %}}
| 名前  | 年齢 | 身長 (cm) | 体重 (kg) |
|------|----|----------|----------|
| 太郎  | 25  | 170      | 65       |
| 花子  | 22  | 160      | 50       |
{{% /tab %}}
{{% tab "悪い例" %}}
| 名前  | データ       |
|------|------------|
| 太郎  | 25歳        |
| 太郎  | 170cm      |
| 太郎  | 65kg       |
| 花子  | 22歳        |
| 花子  | 160cm      |
| 花子  | 50kg       |
{{% /tab %}}
{{% /tabs %}}

### 一つの値は一つのセルに（Each value must have its own cell.）
各セルに入る値は，一つだけにするという原則です．名前がAliceというデータについて，身長が2つや3つもあるのは不自然ですよね．
ただし，Tidyverseで提供されているtibbleというデータフレーム(Excelの表の強化版みたいなもの)は一つのセルの中に,配列を入れることができたり，さらにtibbleを格納することもできるので，必ずしもこの原則が達成されているとは限らないので注意が必要です．

{{% tabs "3st_principle" %}}
{{% tab "良い例" %}}
| 名前  | 好きな食べ物 |
|------|----------|
| 太郎  | 寿司     |
| 太郎  | ラーメン  |
| 花子  | カレー   |
| 花子  | パスタ   |
{{% /tab %}}
{{% tab "悪い例" %}}

| 名前  | 好きな食べ物        |
|------|----------------|
| 太郎  | 寿司, ラーメン    |
| 花子  | カレー, パスタ    |
{{% /tab %}}
{{% /tabs %}}

以上の内容を意識すると，統一的な記述方法でデータを解析，整形することができるので，tidy dataを意識してデータ解析すると良いでしょう．

{{% details title="余談" open=false %}}

Tidy Dataが解析しやすいデータだとすれば，それ以外のデータは解析しずらい，めんどくさいデータです．例え人にとって見やすかったり，扱いやすかったりしてもTidyでないならコンピュータには扱いづらいです．そのため，データを提供する側と解析する側では，往々にしてこの部分ですれ違いがあったりするので，何かデータを扱うときはTidyであるかどうかを気にしてみるといいかもしれません．

{{% /details %}}


## パイプライン演算子 `|>`
Tidyverseを使用していく上でパイプライン演算子`|>` を活用することで，処理を簡潔かつ解釈しやすく記述することができます．


### 関数
まず，パイプライン演算子を使う前に，プログラミングにおける関数について説明します．プログラミングにおける関数は，ある処理のまとまりを集めて，いつでも呼び出せるようにしたものです．これは数学における，ある集合からある集合への対応を示す関数とは違い，サブルーチンといった方がより適切です．そのため，処理をまとめただけの関数もあれば，ある入力に対してある出力を返す関数があったりします．

ここで入力に対応するものを引数，出力に対応するものを返り値(戻り値)といいます．

**純粋関数**という概念があります．純粋関数とは所謂，数学における関数と等価なもので，ある入力(引数)に対して，いつも同じ出力(返り値)を返す関数です．この純粋関数を組み合わせることでコーディングをしていくのがTidyverseとパイプラインを組み合わせた方法です．

具体的には純粋関数は，同じ引数に対して，特定の返り値を返すので，ある純粋関数の返り値をそのまま，別の純粋関数の引数に入力することで，処理を記述していきます．これまでのプログラミングといえばやりたいことを逐一丁寧に記述していく手続き型プログラミングといったものを行ってきました．しかし，それとは考え方，アプローチが違ってくるので戸惑う点があるかもしれません．とはいえ，基本的にプログラミングとは何をするかというと，与えられた入力(データ)を加工していく処理，作業に他なりません．その大前提を意識しておけば，どちらもやることがたいして変わりません．以下で具体例を見てみましょう．


{{% details title="余談" open=false %}}

純粋関数とは，ある引数に対して特定の返り値を返す—つまりは引数が同じ時，常に同じ返り値を返すことと，副作用が発生しない関数のことを指します．副作用とは引数以外の入力，返り値以外の出力を伴うことです．具体的には関数の外の変数を参照，変更することであったり，I/O画面やストレージと相互作用をすることを指します．

例えばprint関数であったり(文字を外部に出力するため), random関数(同じ引数を入力しても出力がランダム)といった関数が非純粋関数となります．

しかし，Rにおいてそのような関数は大多数を占めますし，本当の意味で純粋関数は少ないのですが，今回は簡単のために上記ような解説となりました．

{{% /details %}}


### パイプライン演算子を使ってみよう

初めに手続きプログラミング的にコードを書いてみます．以下のコードは，データフレームdfを宣言し，value列の値が20より大きいものを選別し，groupごとに集計し，平均値を算出したものを出力するコードです．
```R
library(dplyr)

df <- data.frame(
    group = c("A", "B", "A", "B", "A"),
    value = c(10, 20, 30, 40, 50)
)

# 一時変数を使った処理
temp1 <- filter(df, value > 20)  # 20より大きい値をフィルタ
temp2 <- group_by(temp1, group)  # "group" でグループ化
result <- summarise(temp2, mean_value = mean(value))  # 平均値を計算

print(result)
```

このようなコードでは，変数temp1, temp2のように演算結果を一時的に保存するためだけの変数を宣言したりと無駄が多いです．無駄が多くなると，論理を追いづらくなったり，コードを手直しするにも大変です．

次の例では一時的な変数を作成しないようにコードを書き直してみます．
```R
result <- summarise(
    group_by(filter(df, value > 20), group),
    mean_value = mean(value)
)

print(result)
```

この書き方では，余計な変数はありませんが，関数の中に関数を書き込んだ形になってしまい，非常に可読性が悪いです．私たちは右から左，外から内に文字を読むのに，処理の流れは左から右に，内から外の順番になってしまっています．
ここでパイプライン演算子の出番です．Rのパイプライン演算子は**ある関数の返り値をそのまま，次の関数の第一引数**にしてしまいます．
```R
library(dplyr)

df |>
    filter(value > 20) |>
    group_by(group) |>
    summarise(mean_value = mean(value)) |>
    print()
```
こうすることによって，処理の流れと記述の流れが同じになりました．純粋関数を用いると同じ引数に対し，同じ返り値が帰ってくるので，このような記述が可能になります．

{{% details title="Advanced" open=false %}}

やや発展的な内容になりますが，パイプライン演算子にはRで定義されたnative pipelineと呼ばれる`|>`とTidyverseのmagrittrパッケージによって提供されている`%>%`の2種類があります．

これらの使い分けとしては，返り値を第一引数ではない場所に用いたい時に，やり方が異なります．

基本的には`|>`の方が速度も早く，何よりパッケージではなく，R言語そのもので定義されているので，`|>`を使用するのを個人的には推奨します．

{{% /details %}}

## Tidyverseで遊んでみよう
お待たせしました．ここからは実際にcsvデータを加工して，Tidyverseの凄さを思い知りましょう．Tidyverseには多くのパッケージが含まれますが，ここではよく使う，dplyrを中心に使っていきます．

ここで加工していくデータは,dplyr内に練習用として定義されているstarwarsのデータを用います．スターウォーズのキャラクターについての情報が詰まれたデータフレームです．
glimpse関数を使用することで，データフレームの概観を知ることができます．(そのままstarwarsと入力するだけでもいいです)

```R
starwars |> glimpse()

#> Rows: 87
#> Columns: 14
#> $ name       <chr> "Luke Skywalker", "C-3PO", "R2-D2", "Darth Vader", "L…
#> $ height     <int> 172, 167, 96, 202, 150, 178, 165, 97, 183, 182, 188, …
#> $ mass       <dbl> 77.0, 75.0, 32.0, 136.0, 49.0, 120.0, 75.0, 32.0, 84.…
#> $ hair_color <chr> "blond", NA, NA, "none", "brown", "brown, grey", "bro…
#> $ skin_color <chr> "fair", "gold", "white, blue", "white", "light", "lig…
#> $ eye_color  <chr> "blue", "yellow", "red", "yellow", "brown", "blue", "…
#> $ birth_year <dbl> 19.0, 112.0, 33.0, 41.9, 19.0, 52.0, 47.0, NA, 24.0, …
#> $ sex        <chr> "male", "none", "none", "male", "female", "male", "fe…
#> $ gender     <chr> "masculine", "masculine", "masculine", "masculine", "…
#> $ homeworld  <chr> "Tatooine", "Tatooine", "Naboo", "Tatooine", "Alderaa…
#> $ species    <chr> "Human", "Droid", "Droid", "Human", "Human", "Human",…
#> $ films      <list> <"A New Hope", "The Empire Strikes Back", "Return of…
#> $ vehicles   <list> <"Snowspeeder", "Imperial Speeder Bike">, <>, <>, <>…
#> $ starships  <list> <"X-wing", "Imperial shuttle">, <>, <>, "TIE Advance…
```

glimpse()を適用すると,行と列がひっくり返ってしまうので注意が必要です．しかし，これでstarwarsが87×14のtibbleで，それぞれの列がどのようなデータを保持しているがわかりました．例えばname列はcharacter(文字列)を保持している列ですね．

次に

## 練習問題

### 問題1

Tidyverseを用いてcsvファイルを読み込み，変数名dfに代入せよ．dfはどのようなデータ形式をしているか確認してください．

{{% details title="Answer" open=false %}}

### 解答1
```R
df <- read_csv("src/sample.csv")
df |> summary()
```

{{% /details %}}

### 問題2

Tidyverseを用いてcsvファイルを読み込み，変数名dfに代入せよ

{{% details title="Answer" open=false %}}

### 解答2
```R
df <- read_csv("src/sample.csv")
```

{{% /details %}}
